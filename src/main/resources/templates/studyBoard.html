<!-- DaisyUI & Tailwind CSS -->
<link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.2/dist/full.min.css" rel="stylesheet" type="text/css"/>
<script src="https://cdn.tailwindcss.com"></script>
<title>나의 공부 일정표</title>
<body>
<!-- 네비바 -->
<nav class="navbar" th:replace="~{navbar :: navbarFragment}"></nav>
<!-- 달력 및 세부 내용 -->
<div class="flex flex-col lg:flex-row mt-12 mx-2 lg:mx-10 lg:mb-10">
    <!-- 타이머 및 스케줄 -->
    <div class="flex flex-col w-full lg:w-2/3 mt-12 lg:mt-0 mx-2 lg:mx-10 lg:mb-10">
        <!-- 타이머 섹션 -->
        <div class="flex-grow place-items-center lg:w-2/3">
            <div class="timer-container" style="text-align: center; margin-top: 50px;">
                <div id="timer" class="timer" style="font-size: 48px;">00:00:00</div>
                <button id="startButton" class="btn">시작</button>
                <button id="saveTimerButton" class="btn">타이머 저장</button>
                <button id="resetButton" class="btn">초기화</button>
            </div>


            <!-- PersonalSchedule 리스트 -->
            <table class="table w-full mt-4">
                <thead>
                <tr>
                    <th>타이머</th>
                    <th>스케줄</th>
                    <th>총 공부 시간</th>
                    <th>삭제</th>
                </tr>
                </thead>
                <tbody id="scheduleList">
                <tr th:each="personalSchedule : ${schedules}" th:data-id="${personalSchedule.id}">
                    <td>
                        <img src="https://i.imgur.com/3bGyIY5.png" style="width: 20px; height: 20px; cursor: pointer;" alt="타이머 시작" class="start-timer"/>
                    </td>
                    <td th:text="${personalSchedule.subject}">공부 리스트</td>
                    <td>
                        <span th:text="${#numbers.formatDecimal(personalSchedule.totalTime / 3600, 2, 0)}">시간</span>
                        <span th:text="':'"></span>
                        <span th:text="${#numbers.formatDecimal((personalSchedule.totalTime % 3600) / 60, 2, 0)}">분</span>
                        <span th:text="':'"></span>
                        <span th:text="${#numbers.formatDecimal(personalSchedule.totalTime % 60, 2, 0)}">초</span>
                    </td>
                    <td>
                        <form th:action="@{/schedules/delete}" method="post" style="display: inline;">
                            <input type="hidden" name="userId" th:value="${user.id}"/>
                            <input type="hidden" name="scheduleId" th:value="${personalSchedule.id}"/>
                            <button type="submit" class="delete-btn">
                                <img src="https://i.imgur.com/lrXmEdG.png" style="width: 20px; height: 20px;" alt="삭제"/>
                            </button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>
            <!-- 스케줄 추가 폼을 포함한 모달 -->
            <button class="btn btn-sm px-2 py-1" onclick="document.getElementById('my_modal_2').showModal()">스케줄 추가</button>
            <dialog id="my_modal_2" class="modal">
                <div class="modal-box">
                    <h3 class="font-bold text-lg">새 스케줄 추가</h3>
                    <form action="#" th:action="@{/schedules}" method="post">
                        <input type="hidden" name="userId" th:value="${userId}">
                        <input type="text" name="subject" placeholder="새 스케줄 제목" class="input input-bordered w-full mb-2"/>
                        <button type="submit" class="btn btn-sm">스케줄 저장</button> <!-- Tailwind CSS 클래스 btn-sm 사용 -->
                    </form>
                </div>
                <form method="dialog" class="modal-backdrop">
                    <button class="btn btn-sm">close</button> <!-- Tailwind CSS 클래스 btn-sm 사용 -->
                </form>
            </dialog>
        </div>
    </div>

    <div class="divider lg:divider-horizontal"></div>
    <div class="flex-grow place-items-center lg:w-2/3">
        <!-- 달력 -->
        <footer th:replace="~{calendar :: calendarFragment}"></footer>

        <!-- 세부내용 -->
        <div class="flex-grow place-items-center lg:w-2/3">
            <!-- 버튼 및 이번 달 일정 -->
            <div class="w-full px-2 mt-2 flex flex-wrap">
                <div class="flex-col">
                    <!-- 버튼 -->
                    <div class="flex justify-between mb-4">
                        <form action="#"
                              th:action="@{/userCalendar/{userCalendarId}(userCalendarId=${userCalendarId})}"
                              method="get">
                            <input type="hidden" name="userCalendarId" th:value="${userCalendarId}">
                            <input type="hidden" name="targetMonth" th:value="${prevMonth}">
                            <button type="submit"
                                    class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-md text-sm text-gray-800">
                                이전달
                            </button>
                        </form>
                        <h1 class="text-xl font-semibold" th:text="${targetMonth + ' 월 일정 리스트'}"></h1>
                        <input type="hidden" name="targetMonth" th:value="${targetMonth}">
                        <form action="#"
                              th:action="@{/userCalendar/{userCalendarId}(userCalendarId=${userCalendarId})}"
                              method="get">
                            <input type="hidden" name="userCalendarId" th:value="${userCalendarId}">
                            <input type="hidden" name="targetMonth" th:value="${nextMonth}">
                            <button type="submit"
                                    class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-md text-sm text-gray-800">
                                다음달
                            </button>
                        </form>
                    </div>
                    <!-- 일정 리스트 -->
                    <div style="overflow-x: auto; width: 700px; height: 500px; border-radius: 10px; border: 0.3px solid lightgray;">
                        <table class="table" style="border-collapse: collapse; width: 100%;">
                            <!-- head -->
                            <thead style="background-color: lightgray;">
                            <tr>
                                <th style="width: 5%;">번호</th>
                                <th style="width: 30%;">일정</th>
                                <th style="width: 25%;">날짜</th>
                                <th style="width: 25%;">사이트</th>
                                <th style="width: 15%;">수정</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="event, iterStat : ${eventsForMonth}" class="flex-wrap w-full lg:w-3/4">
                                <!-- 이벤트의 순서와 제목, 기간 출력 -->
                                <td th:text="${iterStat.index + 1 }"></td>
                                <td style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 200px;"
                                    title="${event.title}" th:text="${event.title}"></td>
                                <td style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 200px;"
                                    title="${event.startDate} + '~' + ${event.endDate}"
                                    th:text="${event.startDate} + '~' + ${event.endDate}"></td>
                                <td style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 200px;">
                                    사이트 정보
                                </td>
                                <td> <!-- 수정 버튼 부분 -->
                                    <!--onclick은 자바스크립트라 타임리프 문법 사용 x-->
                                    <button class="btn" onclick="openModal(this)" th:data-id="${event.id}">Open
                                        modal
                                    </button>
                                    <!-- 모달 요소 -->
                                    <dialog th:id="${'eventModal_' + event.id}" class="modal">
                                        <div class="modal-box">
                                            <h3 class="font-bold text-lg">Modify Event</h3>
                                            <p class="py-4">Press ESC key or click the button below to close</p>
                                            <div class="modal-action">
                                                <form method="dialog">
                                                    <!-- 수정 양식 추가 -->
                                                    <label>Event Title:</label>
                                                    <input type="text" th:id="${'modifiedEventTitle_'+event.id}">
                                                    <br>
                                                    <label>Start Time:</label>
                                                    <input type="datetime-local"
                                                           th:id="${'modifiedEventStart_'+event.id}">
                                                    <br>
                                                    <label>End Time:</label>
                                                    <input type="datetime-local"
                                                           th:id="${'modifiedEventEnd_'+event.id}">
                                                    <br>
                                                    <!-- 수정 완료 버튼 -->
                                                    <button class="btn" onclick="saveModifiedEvent(this)"
                                                            th:data-id="${event.id}">저장
                                                    </button>
                                                    <!-- 모달 닫기 버튼 -->
                                                    <button class="btn" onclick="closeModal(this)"
                                                            th:data-id="${'eventModal_' + event.id}">
                                                        Close
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </dialog>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- FullCalendar & Scripts -->


<script>
    document.addEventListener('DOMContentLoaded', function() {
    let timerInterval;
    let seconds = 0;
    let minutes = 0;
    let hours = 0;
    let currentScheduleId;

    function startTimer(scheduleId) {
        stopTimer();
        currentScheduleId = scheduleId;
        timerInterval = setInterval(updateTimer, 1000);
    }

    function stopTimer() {
        clearInterval(timerInterval);
    }

    function resetTimer() {
        clearInterval(timerInterval);
        seconds = 0;
        minutes = 0;
        hours = 0;
        updateTimerDisplay();
        currentScheduleId = null;
    }

    function updateTimer() {
        seconds++;
        if (seconds === 60) {
            seconds = 0;
            minutes++;
            if (minutes === 60) {
                minutes = 0;
                hours++;
            }
        }
        updateTimerDisplay();
    }

    function updateTimerDisplay() {
        const timerElement = document.getElementById('timer');
        timerElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function saveTimerToSchedule() {
        if (!currentScheduleId) {
            alert("타이머가 시작되지 않았습니다.");
            return;
        }
        stopTimer(); // 타이머 멈추기
        const duration = hours * 3600 + minutes * 60 + seconds;
        fetch('/study-time', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `scheduleId=${currentScheduleId}&duration=${duration}`
        })

        .then(data => {
            console.log("타이머 값 저장 성공", data);
            // 저장이 성공하면 타이머를 멈춘 상태로 유지
        })
        .catch(error => {
            console.error('타이머 값 저장 오류:', error);
            alert('오류: ' + error.message);
        });
    }

    document.querySelectorAll('.start-timer').forEach(function(element) {
        element.addEventListener('click', function() {
            const scheduleId = this.closest('tr').dataset.id;
            startTimer(scheduleId);
        });
    });

    document.getElementById('startButton').addEventListener('click', function() {
        const scheduleId = prompt("스케줄 ID를 입력하세요:");
        startTimer(scheduleId);
    });

    document.getElementById('saveTimerButton').addEventListener('click', saveTimerToSchedule);
    document.getElementById('resetButton').addEventListener('click', resetTimer);
});


</script>
</body>
