<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나의 공부 일정표</title>
    <!-- DaisyUI & Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.2/dist/full.min.css" rel="stylesheet" type="text/css"/>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
<!-- 네비바 -->
<nav th:replace="~{navbar :: navbarFragment}" class="navbar fixed top-0 z-50"></nav>

<!-- 달력 및 세부 내용 -->
<div class="flex w-90 lg:flex-row mt-50 lg:mt-20 mx-2 lg:mx-10 lg:mb-10">
    <!-- 타이머 및 스케줄 -->
    <div class="flex w-90 lg:flex-row mt-50 lg:mt-20 mx-2 lg:mx-10 lg:mb-10">
        <!-- 타이머 섹션 -->
        <div class="flex-grow place-items-center lg:w-2/3">
            <h2>타이머</h2>
            <style>
                .timer-container {
                    text-align: center;
                    margin-top: 50px;
                }
                .timer {
                    font-size: 48px;
                }
                .btn {
                    margin-top: 20px;
                    padding: 10px 20px;
                    font-size: 18px;
                    cursor: pointer;
                }
            </style>

            <div class="timer-container">
                <div id="timer" class="timer">00:00:00</div>
                <button id="startButton" class="btn">시작</button>
                <button id="stopButton" class="btn">정지</button>
                <button id="resetButton" class="btn">초기화</button>
            </div>

            <!-- 타이머 저장 버튼 추가 -->
            <button id="saveTimerButton" class="btn">타이머 저장</button>

            <!-- 스케줄 추가 폼 -->
            <div class="schedule-form mt-4">
                <form action="#" th:action="@{/schedules}" method="post">
                    <input type="hidden" name="userId" th:value="${userId}">
                    <input type="text" name="subject" placeholder="새 스케줄 제목" class="input input-bordered w-full mb-2"/>
                    <button type="submit" class="btn">스케줄 저장</button>
                </form>
            </div>

            <!-- PersonalSchedule 리스트 -->
            <table class="table w-full mt-4">
                <thead>
                <tr>
                    <th>스케줄</th>
                    <th>타이머</th>
                </tr>
                </thead>
                <tbody id="scheduleList">
                <tr th:each="schedule : ${schedules}">
                    <td th:text="${schedule.subject}">공부 리스트</td>
                    <td>
                        <button class="btn" onclick="startTimer([[${schedule.id}]])">타이머 시작</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="divider lg:divider-horizontal"></div>
    <div>
        <!-- 달력 -->
        <div class="flex-grow place-items-center lg:w-2/3">
            <h1>개인 달력</h1>
            <footer th:replace="~{calendar :: calendarFragment}"></footer>

        <!-- 세부내용 -->
        <div class="flex-grow place-items-center lg:w-2/3">
            <!-- 버튼 및 이번 달 일정 -->
            <div class="w-full px-2 mt-2 flex flex-wrap">
                <div class="flex-cole">
                    <!-- 버튼 -->
                    <div class="flex justify-between mb-4">
                        <form action="#" th:action="@{/userCalendar/{userCalendarId}(userCalendarId=${userCalendarId})}" method="get">
                            <input type="hidden" name="userCalendarId" th:value="${userCalendarId}">
                            <input type="hidden" name="targetMonth" th:value="${prevMonth}">
                            <button type="submit"
                                    class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-md text-sm text-gray-800">이전달
                            </button>
                        </form>
                        <h1 class="text-xl font-semibold" th:text="${targetMonth + ' 월 일정 리스트'}"></h1>
                        <input type="hidden" name="targetMonth" th:value="${targetMonth}">
                        <form action="#" th:action="@{/userCalendar/{userCalendarId}(userCalendarId=${userCalendarId})}" method="get">
                            <input type="hidden" name="userCalendarId" th:value="${userCalendarId}">
                            <input type="hidden" name="targetMonth" th:value="${nextMonth}">
                            <button type="submit"
                                    class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-md text-sm text-gray-800">다음달
                            </button>
                        </form>
                    </div>
                    <!-- 일정 리스트 -->
                    <div style="overflow-x: auto; width: 700px; height: 500px; border-radius: 10px; border: 0.3px solid lightgray;">
                        <table class="table" style="border-collapse: collapse; width: 100%;">
                            <!-- head -->
                            <thead style="background-color: lightgray;">
                            <tr>
                                <th style="width: 5%;">번호</th>
                                <th style="width: 30%;">일정</th>
                                <th style="width: 25%;">날짜</th>
                                <th style="width: 25%;">사이트</th>
                                <th style="width: 15%;">수정</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="event, iterStat : ${eventsForMonth}" class="flex-wrap w-full lg:w-3/4">
                                <!-- 이벤트의 순서와 제목, 기간 출력 -->
                                <td th:text="${iterStat.index + 1 }"></td>
                                <td style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 200px;"
                                    title="${event.title}" th:text="${event.title}"></td>
                                <td style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 200px;"
                                    title="${event.startDate} + '~' + ${event.endDate}"
                                    th:text="${event.startDate} + '~' + ${event.endDate}"></td>
                                <td style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 200px;">
                                    사이트 정보
                                </td>
                                <td> <!-- 수정 버튼 부분 -->
                                    <!--onclick은 자바스크립트라 타임리프 문법 사용 x-->
                                    <button class="btn" onclick="openModal(this)" th:data-id="${event.id}">Open modal</button>
                                    <!-- 모달 요소 -->
                                    <dialog th:id="${'eventModal_' + event.id}" class="modal">
                                        <div class="modal-box">
                                            <h3 class="font-bold text-lg">Modify Event</h3>
                                            <p class="py-4">Press ESC key or click the button below to close</p>
                                            <div class="modal-action">
                                                <form method="dialog">
                                                    <!-- 수정 양식 추가 -->
                                                    <label>Event Title:</label>
                                                    <input type="text" th:id="${'modifiedEventTitle_'+event.id}">
                                                    <br>
                                                    <label>Start Time:</label>
                                                    <input type="datetime-local"
                                                           th:id="${'modifiedEventStart_'+event.id}">
                                                    <br>
                                                    <label>End Time:</label>
                                                    <input type="datetime-local"
                                                           th:id="${'modifiedEventEnd_'+event.id}">
                                                    <br>
                                                    <!-- 수정 완료 버튼 -->
                                                    <button class="btn" onclick="saveModifiedEvent(this)"
                                                            th:data-id="${event.id}">저장
                                                    </button>
                                                    <!-- 모달 닫기 버튼 -->
                                                    <button class="btn" onclick="closeModal(this)"
                                                            th:data-id="${'eventModal_' + event.id}">
                                                        Close
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </dialog>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- 일정 추가 버튼 -->
                <div class="flex justify-between mt-4">
                    <button id="addEventBtn"
                            style="border-radius: 10px; padding: 10px 20px; border: none; background-color: black; color: white; text-align: center; display: inline-block; font-size: 16px; cursor: pointer;">
                        일정추가
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FullCalendar & Scripts -->


<script>
    let timerInterval;
    let seconds = 0;
    let minutes = 0;
    let hours = 0;
    let currentScheduleId; // 현재 기록 중인 스케줄의 ID

    function startTimer(scheduleId) {
        // 이전에 실행 중인 타이머가 있으면 정지
        stopTimer();

        // 새로운 스케줄의 타이머 시작
        currentScheduleId = scheduleId;
        timerInterval = setInterval(updateTimer, 1000);
    }

    function stopTimer() {
        clearInterval(timerInterval);
        currentScheduleId = null;
    }

    function resetTimer() {
        clearInterval(timerInterval);
        seconds = 0;
        minutes = 0;
        hours = 0;
        updateTimerDisplay();
        currentScheduleId = null;
    }

    function updateTimer() {
        seconds++;
        if (seconds === 60) {
            seconds = 0;
            minutes++;
            if (minutes === 60) {
                minutes = 0;
                hours++;
            }
        }
        updateTimerDisplay();
    }

    function updateTimerDisplay() {
        const timerElement = document.getElementById('timer');
        timerElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function saveTimerToSchedule() {
        // 현재 타이머가 실행 중이 아니면 아무것도 하지 않음
        if (!currentScheduleId) return;

        const duration = hours * 3600 + minutes * 60 + seconds;

        // 스케줄 ID를 이용하여 해당 스케줄에 타이머 값을 저장
        fetch('/study-time', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `scheduleId=${currentScheduleId}&duration=${duration}`
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('타이머 값 저장 실패');
            }
            return response.json();
        })
        .then(data => {
            console.log("타이머 값 저장 성공", data);
            // 성공적으로 저장되면 타이머 초기화
            resetTimer();
        })
        .catch(error => {
            console.error('타이머 값 저장 오류:', error);
            alert('오류: ' + error.message);
        });
    }

    document.getElementById('startButton').addEventListener('click', function() {
        const scheduleId = prompt("스케줄 ID를 입력하세요:");
        startTimer(scheduleId);
    });

    document.getElementById('stopButton').addEventListener('click', stopTimer);

    document.getElementById('resetButton').addEventListener('click', resetTimer);

    document.getElementById('saveTimerButton').addEventListener('click', saveTimerToSchedule);
</script>
</body>
</html>

<!--풋화면-->
<footer th:replace="~{footer :: footerFragment}"></footer>
