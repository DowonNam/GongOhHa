<div th:fragment="calendarFragment">
    <div>

        <div id='userCalendar'></div>
        <br>
        <!-- 이벤트 추가 모달 -->
        <div id="eventModal"
             style="display:none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000;">
            <div>
                <label>달력 번호:</label>
                <input type="number" id="userCalendar_id"><br>
                <label>제목:</label>
                <input type="text" id="eventTitle"><br>
                <label>시작 시간:</label>
                <input type="datetime-local" id="eventStart"><br>
                <label>종료 시간:</label>
                <input type="datetime-local" id="eventEnd"><br>
                <button id="saveEvent"
                        style="border-radius: 10px; padding: 10px 20px; border: none; background-color: black; color: white; text-align: center; display: inline-block; font-size: 16px; cursor: pointer;">
                    이벤트 저장
                </button>
            </div>
        </div>
    </div>


    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/long/dist/long.js"></script> <!-- Long.js 라이브러리 추가 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('userCalendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
            });
            calendar.render(); // FullCalendar 인스턴스를 렌더링합니다.

            const userCalendarId = window.location.pathname.split('/').pop(); // URL에서 ID 추출

            // 캘린더 ID로 이벤트 불러오기
            fetchEventsForUserCalendar(userCalendarId, calendar);

            document.getElementById('addEventBtn').addEventListener('click', function() {
                document.getElementById('eventModal').style.display = 'block';
            });

            document.getElementById('saveEvent').addEventListener('click', function() {
                addEventToUserCalendar(calendar);
            });
        });

    // events 변수 정의 및 초기화
    let events = [];

    // 이벤트 데이터를 가져오는 fetchEventsForUserCalendar 함수 내부에서 events 변수 업데이트
    function fetchEventsForUserCalendar(userCalendarId, calendar) {
        fetch(`http://localhost:8088/userCalendar/${userCalendarId}/events`)
        .then(response => {
            const contentType = response.headers.get("content-type");
            if (!response.ok || !contentType || !contentType.includes("application/json")) {
                return response.text().then(text => {
                    throw new Error('서버에서 정상적인 JSON 응답이 아닙니다: ' + text);
                });
            }
            return response.json();
        })
        .then(eventsData => {
            // 가져온 이벤트 데이터를 events 변수에 저장
            events = eventsData;

            // FullCalendar에 이벤트 추가
            events.forEach(event => {
                calendar.addEvent({
                    title: event.title,
                    start: event.startDate,
                    end: event.endDate
                });
            });
        })
        .catch(error => {
            console.error('이벤트 불러오기 오류:', error);
            alert('오류: ' + error.message);
        });
    }

    function addEventToUserCalendar(calendar) { // calendar를 함수 인수로 받아옵니다.
        var userCalendar_id = document.getElementById('userCalendar_id').value;
        var title = document.getElementById('eventTitle').value;
        var start = document.getElementById('eventStart').value;
        var end = document.getElementById('eventEnd').value;

        // 이벤트 객체를 생성합니다.
        var event = {
            title: title,
            start: new Date(start),
            end: new Date(end)
        };

        fetch('/userCalendar/events', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                userCalendar_id: parseInt(userCalendar_id, 10),
                title: title,
                startDate: event.start.toISOString(),
                endDate: event.end.toISOString()
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('네트워크 응답이 실패했습니다.');
            }
            return response.json();
        })
        .then(data => {
            calendar.addEvent({ // calendar.addEvent를 호출합니다.
                title: data.title,
                start: data.startDate,
                end: data.endDate
            });

            // 입력 필드 초기화 및 이벤트 모달 숨기기
            document.getElementById('eventModal').style.display = 'none';
            document.getElementById('userCalendar_id').value = '';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventStart').value = '';
            document.getElementById('eventEnd').value = '';
        })
        .catch(error => {
            console.error('오류:', error);
            alert('오류: ' + error.message);
        });
    }

     // 모달 열기 함수 수정
    function openModal(button) {
        var eventId = button.getAttribute('data-id');
        var modalId = 'eventModal_' + eventId;
        var modal = document.getElementById(modalId);

        if (modal) {
            modal.showModal();
        } else {
            console.error("Modal not found with ID:", modalId);
        }
    }

    function saveModifiedEvent(button) {
        var eventId = button.getAttribute('data-id');
        var modifiedEventTitle = document.getElementById('modifiedEventTitle_' + eventId).value;
        var modifiedEventStart = document.getElementById('modifiedEventStart_' + eventId).value;
        var modifiedEventEnd = document.getElementById('modifiedEventEnd_' + eventId).value;

        console.log("Saving event:", eventId, modifiedEventTitle, modifiedEventStart, modifiedEventEnd);

        var updatedEvent = {
            title: modifiedEventTitle,
            startDate: modifiedEventStart,
            endDate: modifiedEventEnd
        };

        console.log("Updated event data:", updatedEvent);

        // 이벤트 ID가 '0'이 아닌지 확인
        if (eventId === '0' || !eventId) {
            console.error("Invalid event ID:", eventId);
            return; // 함수를 여기서 종료
        }

        fetch(`/userCalendar/modify/${eventId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedEvent)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('이벤트 수정 실패');
            }
            return response.json();
        })
        .then(data => {
            console.log("Event updated successfully", data);
        })
        .catch(error => {
            console.error('이벤트 수정 오류:', error);
        });
    }

    // 모달 닫기 함수
    function closeModal(modalId) {
        var modal = document.getElementById(modalId);
        modal.close();
    }
    </script>
</div>