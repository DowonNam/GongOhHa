<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시험 일정 달력</title>
    <!-- DaisyUI & Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.2/dist/full.min.css" rel="stylesheet" type="text/css"/>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
<!-- 네비바 -->
<nav class="navbar fixed top-0 z-50"></nav>

<!-- 달력 및 세부 내용 -->
<div class="flex flex-col w-full lg:flex-row mt-20 ml-10">
    <!-- 달력 -->
    <div class="flex-grow place-items-center">
        <h1>시험 일정 달력</h1>
        <div id='calendar'></div>
        <br>
        <!-- 일정 추가 버튼 -->
        <button id="addEventBtn" style="border-radius: 10px; padding: 10px 20px; border: none; background-color: black; color: white; text-align: center; display: inline-block; font-size: 16px; cursor: pointer;">일정추가</button>
        <!-- 이벤트 추가 모달 -->
        <div id="eventModal" style="display:none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000;">
            <div>
                <label>달력 번호:</label>
                <input type="number" id="calendar_id"><br>
                <label>제목:</label>
                <input type="text" id="eventTitle"><br>
                <label>시작 시간:</label>
                <input type="datetime-local" id="eventStart"><br>
                <label>종료 시간:</label>
                <input type="datetime-local" id="eventEnd"><br>
                <button id="saveEvent" style="border-radius: 10px; padding: 10px 20px; border: none; background-color: black; color: white; text-align: center; display: inline-block; font-size: 16px; cursor: pointer;">이벤트 저장</button>
            </div>
        </div>
    </div>
    <div class="divider lg:divider-horizontal"></div>

    <!-- 세부내용 -->
    <div class="flex-grow place-items-center">
        <h1>이번 달 시험 일정 세부내용</h1>
        <div class="artboard phone-1 bg-base-300">320×568</div>
    </div>
</div>

<!-- FullCalendar & Scripts -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
        });
        calendar.render();

        document.getElementById('addEventBtn').addEventListener('click', function() {
            document.getElementById('eventModal').style.display = 'block';
        });

        fetchEventsForCalendar(1); // calendar_id 1로 이벤트 불러오기

        document.getElementById('saveEvent').addEventListener('click', function() {
            addEventToCalendar(calendar);
        });
    });

    function fetchEventsForCalendar(calendarId) {
        fetch(`/calendar/${calendarId}`)
        .then(response => response.json())
        .then(events => {
            events.forEach(event => {
                calendar.addEvent({
                    title: event.title,
                    start: event.startDate,
                    end: event.endDate
                });
            });
        })
        .catch(error => console.error('이벤트 불러오기 오류:', error));
    }

  function addEventToCalendar(calendar) {
    var calendar_id = document.getElementById('calendar_id').value;
    var title = document.getElementById('eventTitle').value;
    var start = document.getElementById('eventStart').value;
    var end = document.getElementById('eventEnd').value;

    if (isNaN(new Date(start).getTime()) || isNaN(new Date(end).getTime())) {
        console.error('유효하지 않은 날짜 입력');
        alert('날짜 입력이 올바르지 않습니다.');
        return;
    }

    var startISO = new Date(start).toISOString();
    var endISO = new Date(end).toISOString();

    // JSON.stringify()를 사용하여 JSON 형식으로 변환
    var jsonData = JSON.stringify({
        "calendar_id": parseInt(calendar_id, 10),
        "title": title,
        "startDate": startISO,
        "endDate": endISO
    });

    console.log("파싱된 데이터:", jsonData);

    fetch('/calendar/events', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: jsonData
    })

    .then(response => {
        if (!response.ok) {
            throw new Error('네트워크 응답이 실패했습니다.');
        }
        return response.json();
    })
    .then(data => {
        console.log("파싱된 데이터:", data);
        calendar.addEvent({
            title: data.title,
            start: data.startDate,
            end: data.endDate
        });

        document.getElementById('eventModal').style.display = 'none';
        document.getElementById('calendar_id').value = '';
        document.getElementById('eventTitle').value = '';
        document.getElementById('eventStart').value = '';
        document.getElementById('eventEnd').value = '';
    })
    .catch(error => {
        console.error('오류:', error);
        alert('오류: ' + error.message);
    });
}
</script>
</body>
</html>