<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시험 일정 공용 달력</title>
    <!-- DaisyUI & Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.2/dist/full.min.css" rel="stylesheet" type="text/css"/>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
<!-- 네비바 -->
<nav th:replace="~{navbar :: navbarFragment}" class="navbar fixed top-0 z-50"></nav>

<!-- 달력 및 세부 내용 -->
<div class="flex w-90 lg:flex-row mt-10 lg:mt-20 mx-2 lg:mx-10 lg:mb-10">
    <!-- 달력 -->
    <div class="flex-grow place-items-center lg:w-2/3">
        <h1>시험 일정 달력</h1>
        <div id='calendar'></div>
        <br>
        <!-- 이벤트 추가 모달 -->
        <div id="eventModal"
             style="display:none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000;">
            <div>
                <label>달력 번호:</label>
                <input type="number" id="calendar_id"><br>
                <label>제목:</label>
                <input type="text" id="eventTitle"><br>
                <label>시작 시간:</label>
                <input type="datetime-local" id="eventStart"><br>
                <label>종료 시간:</label>
                <input type="datetime-local" id="eventEnd"><br>
                <button id="saveEvent"
                        style="border-radius: 10px; padding: 10px 20px; border: none; background-color: black; color: white; text-align: center; display: inline-block; font-size: 16px; cursor: pointer;">
                    이벤트 저장
                </button>
            </div>
        </div>
    </div>
    <div class="divider lg:divider-horizontal"></div>

    <!-- 세부내용 -->
    <div class="flex flex-col lg:w-1/3 justify-center lg:justify-between gap-4 lg:gap-10 overflow-y-auto">
        <!-- 버튼 및 이번 달 일정 -->
        <div class="w-full px-2 mt-2 flex flex-wrap">
            <div class="flex-cole">
                <!-- 버튼 -->
                <div class="flex justify-between mb-4">
                    <form action="#" th:action="@{/calendar/{calendarId}(calendarId=${calendarId})}" method="get">
                        <input type="hidden" name="calendarId" th:value="${calendarId}">
                        <input type="hidden" name="targetMonth" th:value="${prevMonth}">
                        <button type="submit"
                                class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-md text-sm text-gray-800">이전 달
                        </button>
                    </form>
                    <h1 class="text-xl font-semibold" th:text="${targetMonth + ' 월 일정 리스트'}"></h1>
                    <input type="hidden" name="targetMonth" th:value="${targetMonth}">
                    <form action="#" th:action="@{/calendar/{calendarId}(calendarId=${calendarId})}" method="get">
                        <input type="hidden" name="calendarId" th:value="${calendarId}">
                        <input type="hidden" name="targetMonth" th:value="${nextMonth}">
                        <button type="submit"
                                class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-md text-sm text-gray-800">다음 달
                        </button>
                    </form>
                </div>
                <!-- 일정 리스트 -->
                <div style="overflow-x: auto; width: 700px; height: 500px; border-radius: 10px; border: 0.3px solid lightgray;">
                    <table class="table" style="border-collapse: collapse; width: 100%;">
                        <!-- head -->
                        <thead style="background-color: lightgray;">
                        <tr>
                            <th style="width: 5%;">번호</th>
                            <th style="width: 30%;">일정</th>
                            <th style="width: 25%;">날짜</th>
                            <th style="width: 25%;">사이트</th>
                            <th style="width: 15%;">수정</th> <!-- 이 부분에 수정 -->
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="event, iterStat : ${eventsForMonth}" class="flex-wrap w-full lg:w-3/4">
                            <!-- 이벤트의 순서와 제목, 기간 출력 -->
                            <td th:text="${iterStat.index + 1 }"></td>
                            <td style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 200px;"
                                title="${event.title}" th:text="${event.title}"></td>
                            <td style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 200px;"
                                title="${event.startDate} + '~' + ${event.endDate}"
                                th:text="${event.startDate} + '~' + ${event.endDate}"></td>
                            <td style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 200px;">
                                사이트 정보
                            </td>
                            <td> <!-- 수정 버튼 부분 -->
                                <button class="btn" onclick="openModal('eventModal_${event.id}', '${event.id}')">Open modal</button>
                                <!-- 모달 요소 -->
                                <dialog id="eventModal_${event.id}" class="modal">
                                    <div class="modal-box">
                                        <h3 class="font-bold text-lg">Modify Event</h3>
                                        <p class="py-4">Press ESC key or click the button below to close</p>
                                        <div class="modal-action">
                                            <form method="dialog">
                                                <!-- 수정 양식 추가 -->
                                                <label>Event Title:</label>
                                                <input type="text" id="modifiedEventTitle" value="">
                                                <br>
                                                <label>Start Time:</label>
                                                <input type="datetime-local" id="modifiedEventStart" value="">
                                                <br>
                                                <label>End Time:</label>
                                                <input type="datetime-local" id="modifiedEventEnd" value="">
                                                <br>
                                                <!-- 수정 완료 버튼 -->
                                                <button class="btn" onclick="saveModifiedEvent('${event.id}')">저장</button>
                                                <!-- 모달 닫기 버튼 -->
                                                <button class="btn" onclick="closeModal('eventModal_${event.id}')">
                                                    Close
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </dialog>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- 일정 추가 버튼 -->
            <div class="flex justify-between mt-4">
                <button id="addEventBtn"
                        style="border-radius: 10px; padding: 10px 20px; border: none; background-color: black; color: white; text-align: center; display: inline-block; font-size: 16px; cursor: pointer;">
                    일정추가
                </button>
            </div>
        </div>
    </div>
</div>

<!-- FullCalendar & Scripts -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/long/dist/long.js"></script> <!-- Long.js 라이브러리 추가 -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
        });
        calendar.render(); // FullCalendar 인스턴스를 렌더링합니다.

        const calendarId = window.location.pathname.split('/').pop(); // URL에서 ID 추출

        // 캘린더 ID로 이벤트 불러오기
        fetchEventsForCalendar(calendarId, calendar);

        document.getElementById('addEventBtn').addEventListener('click', function() {
            document.getElementById('eventModal').style.display = 'block';
        });

        document.getElementById('saveEvent').addEventListener('click', function() {
            addEventToCalendar(calendar);
        });
    });

// events 변수 정의 및 초기화
let events = [];

// 이벤트 데이터를 가져오는 fetchEventsForCalendar 함수 내부에서 events 변수 업데이트
function fetchEventsForCalendar(calendarId, calendar) {
    fetch(`http://localhost:8088/calendar/${calendarId}/events`)
    .then(response => {
        const contentType = response.headers.get("content-type");
        if (!response.ok || !contentType || !contentType.includes("application/json")) {
            return response.text().then(text => {
                throw new Error('서버에서 정상적인 JSON 응답이 아닙니다: ' + text);
            });
        }
        return response.json();
    })
    .then(eventsData => {
        // 가져온 이벤트 데이터를 events 변수에 저장
        events = eventsData;

        // FullCalendar에 이벤트 추가
        events.forEach(event => {
            calendar.addEvent({
                title: event.title,
                start: event.startDate,
                end: event.endDate
            });
        });
    })
    .catch(error => {
        console.error('이벤트 불러오기 오류:', error);
        alert('오류: ' + error.message);
    });
}

function addEventToCalendar(calendar) { // calendar를 함수 인수로 받아옵니다.
    var calendar_id = document.getElementById('calendar_id').value;
    var title = document.getElementById('eventTitle').value;
    var start = document.getElementById('eventStart').value;
    var end = document.getElementById('eventEnd').value;

    // 이벤트 객체를 생성합니다.
    var event = {
        title: title,
        start: new Date(start),
        end: new Date(end)
    };

    fetch('/calendar/events', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            calendar_id: parseInt(calendar_id, 10),
            title: title,
            startDate: event.start.toISOString(),
            endDate: event.end.toISOString()
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('네트워크 응답이 실패했습니다.');
        }
        return response.json();
    })
    .then(data => {
        calendar.addEvent({ // calendar.addEvent를 호출합니다.
            title: data.title,
            start: data.startDate,
            end: data.endDate
        });

        // 입력 필드 초기화 및 이벤트 모달 숨기기
        document.getElementById('eventModal').style.display = 'none';
        document.getElementById('calendar_id').value = '';
        document.getElementById('eventTitle').value = '';
        document.getElementById('eventStart').value = '';
        document.getElementById('eventEnd').value = '';
    })
    .catch(error => {
        console.error('오류:', error);
        alert('오류: ' + error.message);
    });
}

 // 모달 열기 함수 수정
  function openModal(modalId, eventId) {
    var modal = document.getElementById(modalId);
    modal.showModal();

    // 수정 양식의 각 입력란에 이벤트 객체의 속성 값 할당
    if (eventId) {
        // 시작 시간 및 종료 시간을 ISO 형식으로 변환하여 할당
        var event = events.find(event => event.id === eventId); // 이벤트 객체 찾기
        if (event) {
            document.getElementById('modifiedEventTitle').value = event.title;
            document.getElementById('modifiedEventStart').value = event.start.toISOString().slice(0, 16); // 시작 시간 설정
            document.getElementById('modifiedEventEnd').value = event.end.toISOString().slice(0, 16); // 종료 시간 설정

            // 이벤트 ID를 Long으로 변환하여 할당
            var eventIdLong = eventId;
        }
    }
}

    // 이벤트 ID를 Long으로 변환하는 함수
    function toLong(eventId) {
        return Long.fromString(eventId);
    }

function saveModifiedEvent(eventId) {
    var modifiedEventTitle = document.getElementById('modifiedEventTitle').value;
    var modifiedEventStart = document.getElementById('modifiedEventStart').value;
    var modifiedEventEnd = document.getElementById('modifiedEventEnd').value;

    // 이벤트 객체를 생성합니다.
    var updatedEvent = {
        title: modifiedEventTitle,
        start: new Date(modifiedEventStart),
        end: new Date(modifiedEventEnd)
    };

    // 이벤트 ID를 Long으로 변환합니다.
    var eventIdLong = Long.fromString(eventId);

    // 서버로 수정된 이벤트 정보 전송
    fetch(`/calendar/modify/${eventIdLong.toString()}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(updatedEvent)
    })
        .then(response => {
            if (!response.ok) {
                throw new Error('이벤트 수정 실패');
            }
            return response.json();
        })
        .then(data => {
            // 성공적으로 수정된 경우, 닫기 버튼을 클릭하여 모달을 닫습니다.
            closeModal(`eventModal_${eventId}`);

            // FullCalendar에서 이벤트 업데이트
            var event = calendar.getEventById(eventId);
            if (event) {
                event.setProp('title', data.title);
                event.setStart(data.startDate);
                event.setEnd(data.endDate);
            }
        })
        .catch(error => {
            console.error('이벤트 수정 오류:', error);
            alert('이벤트 수정 중 오류가 발생했습니다.');
        });
}

// 모달 닫기 함수
function closeModal(modalId) {
    var modal = document.getElementById(modalId);
    modal.close();
}
</script>
</body>
</html>

<!--풋화면-->
<footer th:replace="~{footer :: footerFragment}"></footer>