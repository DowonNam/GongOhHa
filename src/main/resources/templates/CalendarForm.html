<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시험 일정 달력</title>
    <!-- DaisyUI & Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.2/dist/full.min.css" rel="stylesheet" type="text/css"/>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
<!-- 네비바 -->
<nav th:replace="~{navbar :: navbarFragment}" class="navbar fixed top-0 z-50"></nav>

<!-- 달력 및 세부 내용 -->
<div class="flex w-full lg:flex-row mt-10 lg:mt-20 mx-2 lg:mx-10">
    <!-- 달력 -->
    <div class="flex-grow place-items-center lg:w-2/3">
        <h1>시험 일정 달력</h1>
        <div id='calendar'></div>
        <br>
        <!-- 일정 추가 버튼 -->
        <button id="addEventBtn" style="border-radius: 10px; padding: 10px 20px; border: none; background-color: black; color: white; text-align: center; display: inline-block; font-size: 16px; cursor: pointer;">일정추가</button>
        <!-- 이벤트 추가 모달 -->
        <div id="eventModal" style="display:none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000;">
            <div>
                <label>달력 번호:</label>
                <input type="number" id="calendar_id"><br>
                <label>제목:</label>
                <input type="text" id="eventTitle"><br>
                <label>시작 시간:</label>
                <input type="datetime-local" id="eventStart"><br>
                <label>종료 시간:</label>
                <input type="datetime-local" id="eventEnd"><br>
                <button id="saveEvent" style="border-radius: 10px; padding: 10px 20px; border: none; background-color: black; color: white; text-align: center; display: inline-block; font-size: 16px; cursor: pointer;">이벤트 저장</button>
            </div>
        </div>
    </div>
    <div class="divider lg:divider-horizontal"></div>

    <!-- 세부내용 -->
    <div class="flex flex-col lg:w-1/2 justify-center lg:justify-between gap-4 lg:gap-10 overflow-y-auto">
        <!-- 버튼 및 이번 달 일정 -->
        <div class="w-full px-2 mt-2 flex flex-wrap">
            <div class="flex-cole">
                <!-- 버튼 -->
                <div class="flex justify-between mb-4">
                    <form action="#" th:action="@{/calendar/{calendarId}(calendarId=${calendarId})}" method="get">
                        <input type="hidden" name="calendarId" th:value="${calendarId}">
                        <input type="hidden" name="targetMonth" th:value="${prevMonth}">
                        <button type="submit" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-md text-sm text-gray-800">이전 달</button>
                    </form>
                    <h1 class="text-xl font-semibold">이번 달 시험 일정 리스트</h1>
                    <form action="#" th:action="@{/calendar/{calendarId}(calendarId=${calendarId})}" method="get">
                        <input type="hidden" name="calendarId" th:value="${calendarId}">
                        <input type="hidden" name="targetMonth" th:value="${nextMonth}">
                        <button type="submit" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-md text-sm text-gray-800">다음 달</button>
                    </form>
                </div>
                <!-- 이번 달 이벤트 리스트 -->
                <div class="artboard phone-1 bg-base-300 flex flex-wrap">
                    <ul class="flex flex-wrap">
                        <!-- Thymeleaf 반복문 -->
                        <li th:each="event : ${eventsForMonth}" class="flex-none w-full lg:w-1/2">
                            <!-- 이벤트의 제목과 기간 출력 -->
                            <span th:text="${event.title} + ' - ' + ${event.startDate} + ' ~ ' + ${event.endDate}"></span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FullCalendar & Scripts -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
        });
        calendar.render(); // FullCalendar 인스턴스를 렌더링합니다.

        const calendarId = window.location.pathname.split('/').pop(); // URL에서 ID 추출

        // 캘린더 ID로 이벤트 불러오기
        fetchEventsForCalendar(calendarId, calendar);

        document.getElementById('addEventBtn').addEventListener('click', function() {
            document.getElementById('eventModal').style.display = 'block';
        });

        document.getElementById('saveEvent').addEventListener('click', function() {
            addEventToCalendar(calendar);
        });
    });

    function fetchEventsForCalendar(calendarId, calendar) { // calendar를 함수 인수로 받아옵니다.
        fetch(`http://localhost:8088/calendar/${calendarId}/events`) // 이 부분은 경로 변수로 올바르게 설정되어 있습니다.
        .then(response => {
            const contentType = response.headers.get("content-type");
            if (!response.ok || !contentType || !contentType.includes("application/json")) {
                return response.text().then(text => {
                    throw new Error('서버에서 정상적인 JSON 응답이 아닙니다: ' + text);
                });
            }
            return response.json();
        })
        .then(events => {
            events.forEach(event => {
                calendar.addEvent({ // calendar.addEvent를 호출합니다.
                    title: event.title,
                    start: event.startDate,
                    end: event.endDate
                });
            });
        })
        .catch(error => {
            console.error('이벤트 불러오기 오류:', error);
            alert('오류: ' + error.message);
        });
    }

    function addEventToCalendar(calendar) { // calendar를 함수 인수로 받아옵니다.
        var calendar_id = document.getElementById('calendar_id').value;
        var title = document.getElementById('eventTitle').value;
        var start = document.getElementById('eventStart').value;
        var end = document.getElementById('eventEnd').value;

        // 이벤트 객체를 생성합니다.
        var event = {
            title: title,
            start: new Date(start),
            end: new Date(end)
        };

        fetch('/calendar/events', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                calendar_id: parseInt(calendar_id, 10),
                title: title,
                startDate: event.start.toISOString(),
                endDate: event.end.toISOString()
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('네트워크 응답이 실패했습니다.');
            }
            return response.json();
        })
        .then(data => {
            calendar.addEvent({ // calendar.addEvent를 호출합니다.
                title: data.title,
                start: data.startDate,
                end: data.endDate
            });

            // 입력 필드 초기화 및 이벤트 모달 숨기기
            document.getElementById('eventModal').style.display = 'none';
            document.getElementById('calendar_id').value = '';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventStart').value = '';
            document.getElementById('eventEnd').value = '';
        })
        .catch(error => {
            console.error('오류:', error);
            alert('오류: ' + error.message);
        });
    }
</script>
</body>
</html>

<!--풋화면-->
<footer th:replace="~{footer :: footerFragment}"></footer>