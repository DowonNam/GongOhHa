<div th:fragment="calendarFragment" th:with="calendarId=${userCalendarId}">
    <div>
        <div id="userCalendar" th:data-calendar-id="${userCalendarId}"></div>
        <br>
        <!-- 이벤트 추가 모달 -->
        <div id="eventModal"
             style="display:none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000;">
            <div>
                <label>달력 번호:</label>
                <input type="number" id="userCalendar_id" readonly><br>
                <label>제목:</label>
                <input type="text" id="eventTitle"><br>
                <label>시작 시간:</label>
                <input type="datetime-local" id="eventStart"><br>
                <label>종료 시간:</label>
                <input type="datetime-local" id="eventEnd"><br>
                <button id="saveEvent"
                        style="border-radius: 10px; padding: 10px 20px; border: none; background-color: black; color: white; text-align: center; display: inline-block; font-size: 16px; cursor: pointer;">
                    이벤트 저장
                </button>
            </div>
        </div>

        <!-- 일정 추가 버튼 -->
        <div class="flex justify-between mt-4">
            <button id="addEventBtn"
                    style="border-radius: 10px; padding: 10px 20px; border: none; background-color: black; color: white; text-align: center; display: inline-block; font-size: 16px; cursor: pointer;">
                일정추가
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/long/dist/long.js"></script> <!-- Long.js 라이브러리 추가 -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('userCalendar');
            var userCalendarId = calendarEl.getAttribute('data-calendar-id');
            console.log("User Calendar ID:", userCalendarId);

            // 모달을 열 때 캘린더 아이디를 설정합니다.
            document.getElementById('addEventBtn').addEventListener('click', function () {
                document.getElementById('userCalendar_id').value = userCalendarId;
                document.getElementById('eventModal').style.display = 'block';
            });

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
            });
            calendar.render(); // FullCalendar 인스턴스를 렌더링합니다.

            // 캘린더 ID로 이벤트 불러오기
            fetchEventsForUserCalendar(userCalendarId, calendar);

            document.getElementById('saveEvent').addEventListener('click', function () {
                addEventToUserCalendar(calendar, userCalendarId);
            });
        });

        function fetchEventsForUserCalendar(userCalendarId, calendar) {
            fetch(`http://localhost:8088/userCalendar/${userCalendarId}/events`)
                .then(response => {
                    console.log('Response status:', response.status, response.statusText); // 응답 상태 로그 추가
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`서버에서 정상적인 응답을 받지 못했습니다. 상태 코드: ${response.status}, 내용: ${text}`);
                        });
                    }
                    const contentType = response.headers.get("content-type");
                    if (!contentType || !contentType.includes("application/json")) {
                        throw new Error(`서버에서 정상적인 JSON 응답이 아닙니다. Content-Type: ${contentType}`);
                    }
                    return response.json();
                })
                .then(eventsData => {
                    // 가져온 이벤트 데이터를 FullCalendar에 추가
                    eventsData.forEach(event => {
                        calendar.addEvent({
                            title: event.title,
                            start: event.startDate,
                            end: event.endDate
                        });
                    });
                })
                .catch(error => {
                    console.error('이벤트 불러오기 오류:', error);
                    alert('오류: ' + error.message);
                });
        }

        function addEventToUserCalendar(calendar, userCalendarId) {
            var title = document.getElementById('eventTitle').value;
            var start = document.getElementById('eventStart').value;
            var end = document.getElementById('eventEnd').value;
            var registrationLink = ""; // 만약 registrationLink가 필요하다면 이곳에서 값을 설정하세요

            // 이벤트 객체를 생성합니다.
            var event = {
                title: title,
                start: new Date(start),
                end: new Date(end)
            };

            fetch('/userCalendar/events', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    calendar_id: parseInt(userCalendarId, 10),
                    title: title,
                    startDate: event.start.toISOString(),
                    endDate: event.end.toISOString(),
                    registrationLink: registrationLink
                })
            })
                .then(response => {
                    console.log('Response status:', response.status, response.statusText); // 응답 상태 로그 추가
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`네트워크 응답이 실패했습니다. 상태 코드: ${response.status}, 내용: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    calendar.addEvent({
                        title: data.title,
                        start: data.startDate,
                        end: data.endDate
                    });

                    // 입력 필드 초기화 및 이벤트 모달 숨기기
                    document.getElementById('eventModal').style.display = 'none';
                    document.getElementById('userCalendar_id').value = '';
                    document.getElementById('eventTitle').value = '';
                    document.getElementById('eventStart').value = '';
                    document.getElementById('eventEnd').value = '';
                })
                .catch(error => {
                    console.error('오류:', error);
                    alert('오류: ' + error.message);
                });
        }

        function openModal(button) {
            var eventId = button.getAttribute('data-id');
            var modalId = 'eventModal_' + eventId;
            var modal = document.getElementById(modalId);

            if (modal) {
                modal.showModal();
            } else {
                console.error("Modal not found with ID:", modalId);
            }
        }

        function saveModifiedEvent(button) {
            var eventId = button.getAttribute('data-id');
            var modifiedEventTitle = document.getElementById('modifiedEventTitle_' + eventId).value;
            var modifiedEventStart = document.getElementById('modifiedEventStart_' + eventId).value;
            var modifiedEventEnd = document.getElementById('modifiedEventEnd_' + eventId).value;

            console.log("Saving event:", eventId, modifiedEventTitle, modifiedEventStart, modifiedEventEnd);

            var updatedEvent = {
                title: modifiedEventTitle,
                startDate: modifiedEventStart,
                endDate: modifiedEventEnd
            };

            console.log("Updated event data:", updatedEvent);

            if (eventId === '0' || !eventId) {
                console.error("Invalid event ID:", eventId);
                return;
            }

            fetch(`/userCalendar/modify/${eventId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedEvent)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('이벤트 수정 실패');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Event updated successfully", data);
                })
                .catch(error => {
                    console.error('이벤트 수정 오류:', error);
                });
        }

        function closeModal(modalId) {
            var modal = document.getElementById(modalId);
            modal.close();
        }
    </script>
</div>
